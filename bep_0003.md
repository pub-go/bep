# The BitTorrent Protocol Specification
## BEP 3
> 原文：[bep_0003.rst](https://github.com/bittorrent/bittorrent.org/blob/master/beps/bep_0003.rst)

BitTorrent 是一种分发文件的协议。它通过URL识别内容，并被设计为与网络无缝整合。
与普通的HTTP相比，它的优势在于，同一文件的下载者之间会互相上传，
这样一个文件可以支持非常多的下载者，而不会让服务器负载随着下载者增大而大幅增大。

### 一个 BitTorrent 文件分发系统由这些实体组成：
- 一个普通的网络服务器（WebServer）
- 一个静态的 "metainfo" 文件（就是种子文件 .torrent）
- 一个 BitTorrent 追踪器(Tracker)
- 一个 "original(原始的,最初的)" 下载者（制作种子的那个人）
- 最终用户的网络浏览器
- 最终用户的下载器

理想情况下，一个文件有许多最终用户。

### 服务器要做的步骤
1. 启动/运行一个追踪器(Tracker)。
2. 启动/运行一个网络服务器。
3. 在网络服务器中将 `.torrent` 后缀名与 MIME 类型 `application/x-bittorrent` 相关联。
4. 对源文件生成带有追踪器地址(tracker url)的种子文件(.torrent)。
5. 将种子文件置于网络服务器中。
6. 在网页中放置指向种子文件的链接(以供用户点击下载)。
7. 启动原始下载者。

### 普通下载者要做的步骤：
1. 安装 BitTorrent（或其他支持 BT 下载的软件）。
2. 网上冲浪（找到种子文件）。
3. 点击指向种子文件的链接。
4. （BT 下载软件应当会询问）要将文件保存在哪里，或者（之前下载过这个文件但没完成就）续传。
5. 开始下载文件，等待下载完成。
6. 关闭下载器（否则会持续上传）。

### bencoding 种子文件编码
- `String` 字符串编码后以长度(十进制)为前缀，后面是冒号和字符串。例如，`4:spam` 对应的是 `"spam"`.
- `Integers` 整数编码后以 `i` 开头后接数字本身，并以 `e` 结尾。例如 `i3e` 表示 `3`，`i-3e` 表示 `-3`。
  整数没有大小限制。`i-0e` 是非法编码。除 `0` 本身用 `i0e` 表示外，其他数字都不能有前导 0， 否则视为非法编码（如 `i03e`）。
- `List` 列表编码以 `l` 开头，然后紧跟着每个元素(每个元素也都需要编码)，并以 `e` 结尾。如 `l4:spam4:eggse` 表示 `["spam", "eggs"]`.
- `Dictionaries` 字典编码以 `d` 开头，然后是每个键值对，并以 `e` 结尾。如 `d3:cow3:moo4:spam4:eggse` 表示 `{"cow":"moo", "spam":"eggs"}`,
  `d4:spaml1:a1:bee` 表示 `{"spam": ["a", "b"]}`. 键必须是字符串，而且需要排序（以原始字符串排序，而不是以字母数字排序）。

> 注：
> 笔者用 Go 语言实现的版本: [pub-go/bencode](https://github.com/pub-go/bencode)

### metainfo files 种子文件
种子文件是一个 bencoding 编码后对字典，内含如下键：
- `announce` 追踪器地址(tracker url).
- `info` 也是一个字典，见下一节。
种子文件中所有的字符串都必须是 UTF-8 编码的。

### info 字典
`name` 字段，可选，表示文件或文件夹目录保存时的建议名称，UTF-8 编码的。该字段纯粹是建议性的。

`piece length` 字段，表示每个片段的长度（字节数）。
为了传输方便，文件会被分割为固定大小的片段，除了最后一个片段大小可能不一样，所有片段的长度都相同。
片段长度几乎总是 2 的幂次方，最常见的是 2^18 = 256k. (BitTorrent 3.2 之前的版本默认使用 2 20 = 1 M)

`pieces` 字段，是一个字符串，其长度为 20 的倍数。每 20 个长度对应一个片段的 SHA1 哈希值。

还有两个字段是 `length` 和 `files`, 这两个字段必须且只能出现一个。
如果有 `length`, 则表示下载的是单个文件，其值是文件长度（字节数），否则 `files` 表示下载的是多个文件。

为了统一字段含义，多个文件的情况，我们将这些文件按他们在 `files` 中出现的顺序拼接起来，将其视为一个文件。
（例如计算 `piece length` 和 `pieces` 时，将 files 中的所有文件拼接起来看待，再进行分片）
`files` 是一个 `List`，每个元素是一个 `Dict`，其中的字段如下：
- `length` 文件长度（字节数）。
- `path` 是一个 `List`, 表示路径，其中的元素是 UTF-8 编码的 `String`,
   最后一项是文件名，文件名之前的(如有)是子目录名。这个 `List` 长度必须大于 0.

单个文件时，`name` 字段表示文件名称, 多个文件时，`name` 表示目录名称。

### trackers 追踪器
Tracker 接收的 GET 请求有如下字段：
- `info_hash`

  种子文件中 `info` 字段的值经过 SHA1 编码的后的 20 字节。这个值总是需要转义。

  Note that this is a substring of the metainfo file.

- `peer_id`
- `ip`
- `port`
- `uploaded`
- `downloaded`
- `left`
- `event`
